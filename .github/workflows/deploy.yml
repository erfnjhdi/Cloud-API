name: Deploy to EC2 via SSM

on:
  push:
    branches: ["main"]

concurrency:
  group: deploy-main
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Send deploy command (SSM)
        id: send
        run: |
          set -e
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ secrets.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "Deploy Cloud-API from GitHub Actions" \
            --parameters '{"commands":["sudo -u ubuntu bash -lc \"cd /opt/cloud-tasks-api && git fetch --all && git reset --hard origin/main && docker compose up -d --build && docker image prune -f\""]}' \
            --query "Command.CommandId" --output text)
      
          echo "command_id=$COMMAND_ID" >> "$GITHUB_OUTPUT"
          echo "SSM CommandId: $COMMAND_ID"

      - name: Wait for command completion
        run: |
          set -e
          for i in {1..60}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id "${{ steps.send.outputs.command_id }}" \
              --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
              --query "Status" --output text || true)
            echo "Status: $STATUS"
            if [ "$STATUS" = "Success" ]; then exit 0; fi
            if [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              aws ssm get-command-invocation \
                --command-id "${{ steps.send.outputs.command_id }}" \
                --instance-id "${{ secrets.EC2_INSTANCE_ID }}" \
                --query "StandardErrorContent" --output text
              exit 1
            fi
            sleep 5
          done
          echo "SSM command did not complete in time"
          exit 1
